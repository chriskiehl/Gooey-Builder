<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Gooey Designer</title>
    <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans+Condensed:700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="css/builder.css">
    <script src="javascript/jquery-2.1.3.js"></script>
    <script src="javascript/Bacon.js"></script>
    <script src="javascript/lodash.js"></script>

    <script>
        fieldMap = {
            FileChooser : ['help', 'command'],
            MultiFileChooser: ['help', 'command'],
            DirChooser: ['help', 'command'],
            FileSaver: ['help', 'command'],
            DateChooser: ['help', 'command'],
            TextField: ['help', 'command', 'nargs'],
            Dropdown: ['help', 'command', 'choices'],
            Counter:  ['help', 'command', 'filled-choices'],
            CheckBox: ['help', 'command'],
            RadioGroup: ['options']
        };

        previewWidgetMap = {
            Default: '#rpreview-default-template',
            FileChooser : '#rpreview-chooser-template',
            MultiFileChooser: '#rpreview-chooser-template',
            DirChooser: '#rpreview-chooser-template',
            FileSaver: '#rpreview-chooser-template',
            DateChooser: '#rpreview-chooser-date-template',
            TextField: '#rpreview-textfield-template',
            Dropdown: '#rpreview-dropdown-template',
            Counter:  '#rpreview-counter-template',
            CheckBox: '#rpreview-checkbox-template',
            RadioGroup: '#rpreview-radio-template'
        };

        stuff = {
            'help': '#help-template',
            'command': '#flag-template',
            'nargs': '#nargs-template',
            'choices': '#choices-template',
            'groupname': '#group-name-template',
            'options': '#radio-options-template'
        };

        function RenderedPreview($) {
            var programTitle = $('.programTitle');
        }

        function textFieldValue(textField) {
            function value() { return textField.val() }
            return textField.asEventStream("keyup").map(value).toProperty(value())
        }

        function textElmValue(textField) {
            function value() { return textField.text() }
            return textField.asEventStream("keyup").map(value).toProperty(value())
        }

        reflowWidgets = _.curry(function(target, section, val) {
            var widgetContainer = $(target);
            var editorItems = _.map($(section).children(), function(x) { return $(x).attr('data-preview-target')});
            if (!editorItems) {return}
            var previewItems = _.map(editorItems, function(previewId) {return $('#' + previewId); });
            var groupedItems = _.chunk(previewItems, _.parseInt(val));
            var rows = _.map(groupedItems, function(itemGroup) {
               return $('<div class="row"></div>').append(itemGroup);
            });
            widgetContainer.html(rows);
        });

        reflowReqs = reflowWidgets('#req-widget-section', '.required-section');
        reflowOpts = reflowWidgets('#opt-widget-section', '.optionals-section');

        swapPosition = _.curry(function(position, action, event) {
            group = $(this).parents('.widget-input-group');
            var nextElement = group[position]('.widget-input-group');
            if (nextElement) {
                group[action](nextElement);
            }
        });

        $(document).ready(function() {
            LIST_TEMPLATE = $('#new-widget-template').children();
            WIDGET_OPTION_PANEL = $('#widget-option-panel-template').children();
            PILL = $('#option-pill-template').children();

            editor = $('.editor-content');

            programTitleField = textFieldValue($('#programName'));
            programDescription = textFieldValue($('#programDescription'));
            widthField = textFieldValue($('#widthField'));
            heightField = textFieldValue($('#heightField'));
            reqCols = textFieldValue($('#reqCols'));
            optCols = textFieldValue($('#optCols'));
            moveUpBtn = $('.move-up');
            moveDownBtn = $('.move-down');
            addRequirement = $('.plus');
            sliderCtrl = $('.roll-toggle');

            programTitleField.assign($('#program-title'), 'text');
            programDescription.assign($('#preview-settings'), 'text');
            widthField.assign($('#title-bar, .program-window'), 'css', 'width');
            heightField.assign($('.program-window'), 'css', 'height');
            reqCols.onValue(reflowReqs);
            optCols.onValue(reflowOpts);

            editor.on('click', '.move-up', swapPosition('prev', 'insertBefore'));
            editor.on('click', '.move-down', swapPosition('next', 'insertAfter'));


            editor.delegate('h4[contenteditable]', 'keydown', function(e) {
                if (e.keyCode === 13) {
                    $(this).blur();
                    return false;
                }
            });

            editor.on('click', '.roll-toggle', function(e) {
                var changeUiState = function(action, newClass) {
                    rollToggle.parents('.widget-input-group').children('.widget-group-options')[action]();
                    var prevClasses = _.dropRight(rollToggle.attr('class').split(' ')).join(' ');
                    rollToggle.attr('class', prevClasses + ' ' + newClass);
                };
                var rollToggle = $(this);
//                var children = rollToggle.parents('.widget-input-group').children('.widget-group-options');
                if (rollToggle.attr('class').indexOf('is-expanded') > -1) {
                    changeUiState('slideUp', 'is-collapsed');
                } else {
                    changeUiState('slideDown', 'is-expanded');
                }
            });

            editor.on('click', '.remove-button', function(e) {
                var group = $(this).parents('.widget-input-group');
                var targetId = group.attr('data-preview-target');
                group.slideUp(function() { $(this).remove(); });
                $('#' + targetId).fadeOut(function() { $(this).remove(); });
            });


            addRequirement.on('click', function(e) {
                function isReq(x) { return x.attr('id').indexOf('required') > -1 }
                var previewSection = isReq($(this)) ? $('#req-widget-section') : $('#opt-widget-section');
                var editSection    = isReq($(this)) ? $('.required-section') : $('.optionals-section');

                var idStamp = new Date().getTime();
                var previewWidget = $(previewWidgetMap.Default).clone();
                previewWidget.attr('id', idStamp);
                previewSection.append(previewWidget);

                var title = editSection
                    .append(LIST_TEMPLATE.clone()
                    .attr('data-preview-target', idStamp))
                    .find('.widget-group-title').last().focus();
                highlightContentEditable(title[0]);

                textElmValue(title).assign(previewWidget.find('.name'), 'text');

                $('.editor-content').animate({ scrollTop: $('.meta-section').height() + previewSection.height() });
//            else {
//                var widgets = $('.optionals-section').append(LIST_TEMPLATE.clone());
//                var title = widgets.find('.widget-group-title').last().focus()[0];
//                highlightContentEditable(title);
//                $('.editor-content').animate({ scrollTop: $('.widget-section').height() + $('.editor-content').height() });
//            }
            });


            function highlightContentEditable(element) {
                var range = document.createRange();
                range.selectNodeContents(element);
                var sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            }


            $(document).delegate('.widget-selector', 'change', function(e) {
                var fields = _.map(fieldMap[$(this).val()], function(field) { return $(stuff[field]).clone().removeAttr('id') });
                var group = $(this).parents('.widget-group-options');
                group.children().slice(1).remove();
                group.append(fields);

                var groupParent = $(this).parents('.widget-input-group');
                var previewId = groupParent.attr('data-preview-target');
                var target = $('#' + previewId);

                var newWidget = $(previewWidgetMap[$(this).val()]).clone().attr('id', previewId);
                target.replaceWith(newWidget);
                textElmValue(groupParent.find('.widget-group-title')).assign(newWidget.find('.name'), 'text');
                textFieldValue(groupParent.find('.wfield-help')).assign(newWidget.find('.help-msg'), 'text');
                groupParent.find('.wfield-choices').on('blur', function() {
                    var choices = _.map($(this).val().split(','), function(choice) {
                        return '<option>' + choice + '</option>'
                    });
                    newWidget.find('select').children().slice(1).remove();
                    newWidget.find('select').append(choices);

                })
            });


            $(document).delegate('.add-group-option', 'click', function(e) {
                WIDGET_OPTION_PANEL.clone().insertBefore($(this).next('.options-disp-box')).animate({'left': '0'}, 200);
            });


            $(document).delegate('.wfield-cancel', 'click', function(e) {
                $(this).parents('.widget-option-panel').animate({'left': 400}, 200, function() {
                    $(this).remove();
                });
            });


            function rumble(element, amount) {
                if (amount === 0) { return; }
                element.css('position', 'relative')
                    .animate({'left': '2px'}, 50)
                    .animate({'left': '0px'}, 50);
                return rumble(element, amount - 1);
            };

            $(document).delegate('.options-disp-box', 'change', function(e) {
                var targetWidget = $('#' + $(this).parents('.widget-input-group').attr('data-preview-target'));
                var buttons = targetWidget.find('.radio');
                var names = _.map($(this).children(), function(pill) { return $(pill).data('name'); });
                var radioOptions = _.map(names, function(name) {
                    return '<label><input type="radio" name="1" />' + name + '</label>'
                });
                buttons.children().remove();
                buttons.append(radioOptions);
            });

            $(document).delegate('.wfield-submit', 'click', function(e) {
                var panel = $(this).parents('.widget-option-panel');
                var name = panel.find('.wfield-name');
                var help = panel.find('.wfield-help');
                var flag = panel.find('.wfield-command');
                if (name.val() && flag.val()) {
                    var id = new Date().getTime();
                    var optBox = panel.next('.options-disp-box');
                    if (panel.data('id')) {
                        targetPill = $('#' + panel.data('id'))
                    } else {
                        targetPill = PILL.clone().appendTo(optBox);
                    }
                    targetPill.data('name', name.val());
                    targetPill.data('help', help.val());
                    targetPill.data('flag', flag.val());
                    targetPill.data('id', id);
                    targetPill.attr('id', id);
                    targetPill.attr('title', 'Params: ' + JSON.stringify(targetPill.data()) );
                    targetPill.find('p').text(name.val());
                    $(this).parents('.widget-option-panel').animate({'left': 400}, function () {
                        $(this).remove();
                    });
                    optBox.change();
                } else {
                    if (!name.val()) rumble(name, 4);
                    if (!flag.val()) rumble(flag, 4);
                }
            });

            $(document).delegate('.pill-close', 'click', function(e) {
                var parent = $(this).parents('.options-disp-box');
                parent.children().remove();
                parent.change();
            });

            $(document).delegate('.pill-title', 'click', function(e) {
                var panel = WIDGET_OPTION_PANEL.clone();
                var pillData = $(this).parent().data();
                panel.data(pillData);
                panel.find('h3').text('Editing Radio Option');
                panel.find('.wfield-name').val(pillData.name);
                panel.find('.wfield-help').val(pillData.help);
                panel.find('.wfield-command').val(pillData.flag);

                panel.insertBefore($(this).parents('.options-disp-box')).animate({'left': '0'}, 200);
            });

            $('#add-required').click()
            $('#add-required').click()
        });

    </script>


</head>
<body>
    <div class="header"></div>
    <div class="maincontainer">
        <div class="output-tab"></div>


        <div class="preview">
            <div class="preview-menubar">
                <h2>Preview</h2>
            </div>

            <div class="preview-container">
                <div class="spacer"></div>
                <div class="program">
                    <div id="title-bar">
                        <h4 id="program-title">Program Name</h4>
                    </div>
                    <div class="program-window">
                        <div class="body">
                            <div class="gooey-header">
                                <img src="images/settings2.png">
                                <h4>Settings</h4>
                                <p id="preview-settings">Settings! Get'cha settings here!</p>
                            </div>


                            <div class="body-content">
                                <h4>Required Arguments</h4>
                                <hr style="margin-bottom: 0">
                                <div id="req-widget-section">
                                    <!-- Filled Dynamically -->
                                </div>

                                <h4 style="margin-top: 30px">Optional Arguments</h4>
                                <hr style="margin-bottom: 0">
                                <div id="opt-widget-section">
                                    <!-- Filled Dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="spacer"></div>
            </div>

        </div>






        <!--EDITOR SECTION-->
        <div class="editor">

            <!--SLIDE OUT HELP MENU-->
            <!--<div class="help-panel">-->
                <!--<div class="help-panel-title">-->
                    <!--<h2>Help</h2>-->
                <!--</div>-->
                <!--<div class="help-panel-subtitle">-->
                    <!--<h4 align="center">Target Program</h4>-->
                <!--</div>-->
            <!--</div>-->
            <!--END SLIDE OUT HELP MENU-->


            <div class="editor-menubar">
                <div class="editor-menubar-title">
                    <h2>Gooey Builder</h2>
                </div>
                <div class="menu">
                </div>
            </div>
            <div class="editor-content">
                <div class="meta-section">
                    <h2>Meta Content</h2>
                    <br>
                    <div class="file-selector">
                        <div class="form-group item-group">
                            <label for="targetProgram">Target Program</label><span class="helper"></span>
                            <input type="email" class="form-control" id="targetProgram" placeholder="path/to/target/program">
                        </div>
                        <span class="small-spacer"></span>
                        <button class="btn btn-default item-btn" id="browseButton">Test</button>
                    </div>

                    <div class="form-group">
                        <label for="programName">Program Name</label><span class="helper"></span>
                        <input type="text" class="form-control" id="programName" placeholder="Enter Program Name" value="Cool Program!">
                    </div>

                    <div class="form-group">
                        <label for="programDescription">Description</label><span class="helper"></span>
                        <textarea class="form-control" id="programDescription">Enter program description</textarea>
                    </div>

                    <div class="checkbox">
                        <label><input type="checkbox" checked> Show Config screen</label><span class="helper"></span>
                    </div>

                    <div class="checkbox">
                        <label><input type="checkbox" checked> Show Advanced Config screen</label><span class="helper"></span>
                    </div>

                    <div class="checkbox">
                        <label><input type="checkbox"> Force Start</label><span class="helper"></span>
                    </div>

                    <hr>
                    <h2>Layout</h2>
                    <br>
                    <div class="ctrl-group">
                        <div class="form-group item-group">
                            <label for="widthField">Width</label><span class="helper"></span>
                            <input type="text" class="form-control" id="widthField" placeholder="width" value="570">
                        </div>
                        <span class="small-spacer"></span>
                        <div class="form-group item-group">
                            <label for="heightField">Height</label><span class="helper"></span>
                            <input type="text" class="form-control" id="heightField" placeholder="height" value="500">
                        </div>
                    </div>

                    <br>

                    <div class="ctrl-group">
                        <div class="form-group item-group">
                            <label for="reqCols">Required Cols<span class="helper"></span></label>
                            <input type="text" class="form-control" id="reqCols" placeholder="Columns per row" value="2">
                        </div>
                        <span class="small-spacer"></span>
                        <div class="form-group item-group">
                            <label for="optCols">Optionals Cols<span class="helper"></span></label>
                            <input type="text" class="form-control" id="optCols" placeholder="Columns per row" value="2">
                        </div>
                    </div>

                    <hr>
                    <h2>Widgets</h2>
                    <br>
                    <h4 class="subsection-header"><span class="clipboard"></span>Required Section</h4>
                </div>

                <div class="widget-section">
                    <div class="required-section">
                    </div>
                    <div style="position: relative; margin-bottom: 25px;">
                        <h4><span class="plus" id="add-required"></span>Add Required Argument</h4>
                    </div>

                    <hr>

                    <h4 class="subsection-header" style="left: 25px; margin-bottom: 25px;"><span class="clipboard"></span>Optionals Section</h4>
                    <div class="optionals-section">
                    </div>
                    <div style="position: relative;" >
                        <h4 style="margin-bottom: 50px;"><span class="plus" id="add-optional"></span>Add Optional Argument</h4>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>



<!--           -->
<!-- templates -->
<!--           -->
    <div id="new-widget-template" style="display: none;">
    <div class="widget-input-group">
        <div class="widget-group-header">
            <div class="positional-controllers">
                <span class="controller move-up"></span>
                <span class="controller move-down"></span>
            </div>
            <h4 class="widget-group-title" contenteditable>Edit Me!</h4>
            <span class="stretch-spacer"></span>
            <svg class="controller roll-toggle is-expanded" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 8 8">
                <path style="fill:#364550;" d="M0 0v2h8v-2h-8zm2 3l2 2 2-2h-4zm-2 4v1h8v-1h-8z" />
            </svg>
            <svg class="controller remove-button" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 8 8">
              <path style="fill:#364550;" d="M1.41 0l-1.41 1.41.72.72 1.78 1.81-1.78 1.78-.72.69 1.41 1.44.72-.72 1.81-1.81 1.78 1.81.69.72 1.44-1.44-.72-.69-1.81-1.78 1.81-1.81.72-.72-1.44-1.41-.69.72-1.78 1.78-1.81-1.78-.72-.72z" />
            </svg>
        </div>
        <div class="widget-group-options">
            <div class="inline-spaced-form form-group-sm">
                <select class="form-control widget-selector">
                    <option value="" selected disabled>Select Widget</option>
                    <option>TextField</option>
                    <option>Dropdown</option>
                    <option>Counter</option>
                    <option>CheckBox</option>
                    <option>RadioGroup</option>
                    <option>FileChooser </option>
                    <option>MultiFileChooser</option>
                    <option>DirChooser</option>
                    <option>FileSaver</option>
                    <option>DateChooser</option>
                </select>
            </div>
        </div>
    </div>
</div>



<div id="hidden-templates" style="display: none">
    <div id="help-template" class="inline-spaced-form form-group-sm">
        <input type="text" class="form-control wfield-help" placeholder="Enter Brief Help Message">
    </div>

    <div id="flag-template" class="inline-spaced-form form-group-sm">
        <input type="text" class="form-control wfield-command" placeholder="Flag (-f, --file, etc..)">
    </div>

    <div id="nargs-template" class="form-group form-group-sm">
        <input type="text" class="form-control wfield-nargs" placeholder="Nargs">
    </div>

    <div id="group-name-template" class="form-group form-group-sm">
        <input type="text" class="form-control wfield-nargs" placeholder="Enter the Group Name">
    </div>

    <div id="choices-template" class="choice-group form-group-sm">
        <label for="">Choices<span class="helper"></span></label>
        <input type="text" class="form-control wfield-choices" placeholder="Enter comma separated options">
    </div>

    <div id="radio-options-template" class="choice-group form-group-sm" style="position: relative">
        <label>Options<span class="helper"></span></label><a href="javascript:void(0)" class="add-group-option" style="display: inline-block; float: right">Add New</a>
        <div class="options-disp-box">

        </div>
    </div>

</div>

<div id="widget-option-panel-template" style="display: none">
    <div class="widget-option-panel fuck">
        <h3>New Radio Option</h3>
        <br>
        <div class="inline-spaced-form form-group-sm">
            <input type="text" class="form-control wfield-name" placeholder="Option Display Name">
        </div>

        <div class="inline-spaced-form form-group-sm">
            <input type="text" class="form-control wfield-help" placeholder="Enter Brief Help Message">
        </div>

        <div class="inline-spaced-form form-group-sm">
            <input type="text" class="form-control wfield-command" placeholder="Flag (-f, --file, etc..)">
        </div>

        <button class="btn btn-default wfield-submit" style="float: right; margin-left: 6px">Done</button>
        <button class="btn btn-default wfield-cancel" style="float: right">Cancel</button>
    </div>
</div>


<div id="option-pill-template" style="display: none">
    <div class="option-pill">
        <p class="pill-title">Filename</p><span class="pill-close">x</span>
    </div>
</div>


<div id="rendered-preview-widget-templates" style="display: none">


    <div class="item" id="rpreview-default-template">
        <p class="name">&nbsp;</p>
        <p class="help-msg">No Widget Selected</p>
        <div class="widget">
        </div>
    </div>

    <div class="item" id="rpreview-chooser-template">
        <p class="name">Filename</p>
        <p class="help-msg">Sample help message.</p>
        <div class="widget chooser">
            <input type="text">
            <span></span>
            <input type="submit" value="Browse">
        </div>
    </div>

    <div class="item" id="rpreview-chooser-date-template">
        <p class="name">Filename</p>
        <p class="help-msg">Sample help message.</p>
        <div class="widget chooser">
            <input type="text">
            <span></span>
            <input type="submit" value="Pick Date">
        </div>
    </div>

    <div class="item" id="rpreview-textfield-template">
        <p class="name">Filename</p>
        <p class="help-msg">Sample help message.</p>
        <div class="widget textfield">
            <input type="text">
        </div>
    </div>

    <div class="item" id="rpreview-checkbox-template">
        <p class="name">Filename</p>
        <div class="widget checkbox">
            <label><input type="checkbox" />Sample help message.</label>
        </div>
    </div>

    <div class="item" id="rpreview-radio-template">
        <p class="name">Filename</p>
        <div class="widget radio">
            <label><input type="radio" name="1" />Add options</label>
        </div>
    </div>

    <div class="item" id="rpreview-dropdown-template">
        <p class="name">Filename</p>
        <p class="help-msg">Sample help message.</p>
        <div class="widget dropdown">
            <select>
                <option value="" selected disabled>Select Option</option>
            </select>
        </div>
    </div>

    <div class="item" id="rpreview-counter-template">
        <p class="name">Filename</p>
        <p class="help-msg">Sample help message.</p>
        <div class="widget dropdown">
            <select>
                <option>1</option>
                <option>2</option>
                <option>3</option>
                <option>4</option>
                <option>5</option>
                <option>6</option>
                <option>7</option>
                <option>8</option>
                <option>9</option>
                <option>10</option>
            </select>
        </div>
    </div>
</div>


</body>
</html>


